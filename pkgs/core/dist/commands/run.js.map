{"version":3,"sources":["../../src/commands/run.ts"],"sourcesContent":["import { Command } from \"commander\"\nimport requireDir from \"require-dir\";\nimport path from \"path\"\nimport { z } from \"zod\"\n\nfunction tryRequire(args: { dir: string, modulePath: string, optional?: boolean }) {\n  try {\n    return require(path.join(args.dir, args.modulePath))\n  } catch (e) {\n    if (!!args.optional) return undefined\n    else throw e\n  }\n}\n\ntype Arg = {\n  cwd: string,\n  config: string,\n  routeDir: string\n}\n\nconst submoduleSchema = z.object({\n  configFn: z.function().optional(),\n  preparedContextFn: z.function().optional(),\n  handlerFn: z.function().optional(),\n  adaptorFn: z.function().optional()\n})\n\nexport default new Command()\n  .option('--cwd', 'current working dir', process.cwd())\n  .option('-c, --config', 'config file', './submodule')\n  .option('-r, --routeDir', 'route dir', './routes')\n  .action(async (args: Arg) => {\n    const nonValidatedSubmodule = tryRequire({ dir: args.cwd, modulePath: args.config })\n\n    const submodule = submoduleSchema.parse(nonValidatedSubmodule.default || nonValidatedSubmodule)\n    const config = submodule?.configFn?.() || {}\n    \n    const preparedContext = submodule?.preparedContextFn?.({ config }) || {}\n\n    const routes = requireDir(path.join(args.cwd, args.routeDir))\n    const preparedRoutes = submodule?.handlerFn?.({ config, preparedContext, handlers: routes }) || routes\n\n    await submodule?.adaptorFn?.({ config, preparedContext, router: preparedRoutes })\n  });"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBAAwB;AACxB,yBAAuB;AACvB,kBAAiB;AACjB,iBAAkB;AAElB,SAAS,WAAW,MAA+D;AACjF,MAAI;AACF,WAAO,QAAQ,YAAAA,QAAK,KAAK,KAAK,KAAK,KAAK,UAAU;AAAA,EACpD,SAAS,GAAP;AACA,QAAI,CAAC,CAAC,KAAK;AAAU,aAAO;AAAA;AACvB,YAAM;AAAA,EACb;AACF;AAQA,IAAM,kBAAkB,aAAE,OAAO;AAAA,EAC/B,UAAU,aAAE,SAAS,EAAE,SAAS;AAAA,EAChC,mBAAmB,aAAE,SAAS,EAAE,SAAS;AAAA,EACzC,WAAW,aAAE,SAAS,EAAE,SAAS;AAAA,EACjC,WAAW,aAAE,SAAS,EAAE,SAAS;AACnC,CAAC;AAED,IAAO,cAAQ,IAAI,yBAAQ,EACxB,OAAO,SAAS,uBAAuB,QAAQ,IAAI,CAAC,EACpD,OAAO,gBAAgB,eAAe,aAAa,EACnD,OAAO,kBAAkB,aAAa,UAAU,EAChD,OAAO,OAAO,SAAc;AAC3B,QAAM,wBAAwB,WAAW,EAAE,KAAK,KAAK,KAAK,YAAY,KAAK,OAAO,CAAC;AAEnF,QAAM,YAAY,gBAAgB,MAAM,sBAAsB,WAAW,qBAAqB;AAC9F,QAAM,SAAS,WAAW,WAAW,KAAK,CAAC;AAE3C,QAAM,kBAAkB,WAAW,oBAAoB,EAAE,OAAO,CAAC,KAAK,CAAC;AAEvE,QAAM,aAAS,mBAAAC,SAAW,YAAAD,QAAK,KAAK,KAAK,KAAK,KAAK,QAAQ,CAAC;AAC5D,QAAM,iBAAiB,WAAW,YAAY,EAAE,QAAQ,iBAAiB,UAAU,OAAO,CAAC,KAAK;AAEhG,QAAM,WAAW,YAAY,EAAE,QAAQ,iBAAiB,QAAQ,eAAe,CAAC;AAClF,CAAC;","names":["path","requireDir"]}